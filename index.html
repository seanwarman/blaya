<html>
	<meta content="width=device-width, initial-scale=1" name="viewport" />
	<head>
		<script id="track-list" type="text/javascript" src="track-list.js"></script>
		<link rel="stylesheet" href="index.css">
	</head>
	<body>
    <header>
      <input id="search-input" type="input" placeholder="Search..." />
      <button
          id="jump-to-this-track"
      ></button>
    </header>
		<footer>
			<div id="current-playing-text"></div>
			<audio tabindex="-1" id="player" controls>
				<source id="current-track" type="audio/mpeg"></source>
			</audio>
			<button tabindex="-1" id="prev-button" role="link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M267.5 440.6c9.5 7.9 22.8 9.7 34.1 4.4s18.4-16.6 18.4-29V96c0-12.4-7.2-23.7-18.4-29s-24.5-3.6-34.1 4.4l-192 160L64 241V96c0-17.7-14.3-32-32-32S0 78.3 0 96V416c0 17.7 14.3 32 32 32s32-14.3 32-32V271l11.5 9.6 192 160z"/></svg>
      </button>
			<button tabindex="-1" id="next-button" role="link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 320 512"><path d="M52.5 440.6c-9.5 7.9-22.8 9.7-34.1 4.4S0 428.4 0 416V96C0 83.6 7.2 72.3 18.4 67s24.5-3.6 34.1 4.4l192 160L256 241V96c0-17.7 14.3-32 32-32s32 14.3 32 32V416c0 17.7-14.3 32-32 32s-32-14.3-32-32V271l-11.5 9.6-192 160z"/></svg>
      </button>
		</footer>
	</body>
	<script>
		const state = {
			currentTrackId: null,
      texts: [],
      throttleId: null,
      throttleGap: 500,
		}

		const onClickOrEnter = cb => (e) => {
			if (e.type === "click" || e.key === "Enter") {
				cb(e)
			}
		}

		const updateCurrentTrack = element => {
			document.getElementById(state.currentTrackId)?.classList?.remove('playing')
			state.currentTrackId = element.id
			element.classList.add('playing')
			document.getElementById('current-playing-text').innerHTML = `<div>${element.firstChild.innerText}</div><div>${element.lastChild.innerText}</div>`
		}

		const onPlay = (e) => {
			 const ref = e.currentTarget
			 if (ref) {
				const sourcer = document.getElementById('current-track')
				sourcer.src = ref.getAttribute('data-href')
				const player = document.getElementById('player')
				player.load()
				updateCurrentTrack(ref)
				player.play()
			 }
		}

		const E = (tag, text, href, i) => {
			const newEl = document.createElement(tag)

			newEl.className = 'track'
			newEl.role = 'link'
			newEl.dataset.href = href
			newEl.tabIndex = i
			newEl.id = 'track-' + i

			const [track, album] = text.slice(9, -4).split('/').reverse()

			if (/#/.test(track) || /#/.test(album)) {
				delete newEl
				return
			}

			newEl.innerHTML = '<div class="track-name">' + track + '</div>' + (album ? '<div class="track-album">' + album + '</div>' : '')

			newEl.onclick = onClickOrEnter(onPlay)
			newEl.onkeydown = onClickOrEnter(onPlay)

			return newEl
		}

		const A = (...newEls) => {
			document.body.append(...newEls)
      state.texts = newEls.map(({ innerText }) => innerText)
		}

		const playTrack = (element) => {
			document.getElementById('current-track').src = element.getAttribute('data-href')
			const player = document.getElementById('player')
			player.load()
			updateCurrentTrack(element)
			player.play()
		}

		const onNext = () => {
			const currentTrackEl = document.getElementById(state.currentTrackId)
			if (!currentTrackEl) return playTrack(document.querySelector('.track'))
			playTrack(currentTrackEl.nextElementSibling)
		}

		const onPrev = () => {
			const currentTrackEl = document.getElementById(state.currentTrackId)
			if (!currentTrackEl) return playTrack(document.querySelector('.track'))
			playTrack(currentTrackEl.previousElementSibling)
		}

    const onScrollThisTrack = () => {
      const el = document.getElementById(state.currentTrackId)
      // el.scrollIntoView({ inline: 'center', behavior: 'smooth', block: 'center' })
      el.focus()
    }

    function throttle(fn) {
      return (...args) => {
        if (state.throttleId) clearTimeout(state.throttleId)
        state.throttleId = setTimeout(() => fn(...args), state.throttleGap)
      }
    }

    const onSearch = (e) => {
      if (state.throttleId) clearTimeout(state.throttleId)
      state.throttleId = setTimeout(() => {
        if (e.target.value.length === 0) {
          const elsHidden = document.querySelectorAll('.track[hidden]')
          for (let i = 0; i < elsHidden.length; i++) {
            elsHidden[i].hidden = false
          }
          return
        }

        const els = document.getElementsByClassName('track')

        state.texts.forEach((t,i) => {
          if(RegExp(e.target.value, 'i').test(t)) {
            els[i].hidden = false
          } else {
            els[i].hidden = true
          }
        })

      }, 100)
    }

		// Inject track list into html...
		A(...trackList
			.filter(track =>
		       		!/\/$/.test(track)
				&& (/.mp3$/.test(track) || /.flac$/.test(track))
			)
			.map((track, i) => E('div', track, track, i))
			.filter(Boolean)
		)

		// Buttons...
		document.getElementById('player').onended = onNext
		document.getElementById('next-button').onclick = onClickOrEnter(onNext)
		document.getElementById('next-button').onkeydown = onClickOrEnter(onNext)
		document.getElementById('prev-button').onclick = onClickOrEnter(onPrev)
		document.getElementById('prev-button').onkeydown = onClickOrEnter(onPrev)
    document.getElementById('jump-to-this-track').onclick = onClickOrEnter(onScrollThisTrack)
    document.getElementById('jump-to-this-track').onkeydown = onClickOrEnter(onScrollThisTrack)

    document.getElementById('search-input').onkeydown = e => e.stopPropagation()
    document.getElementById('search-input').oninput = onSearch

		// Key commands...
		const onKey = (...maps) => e => {
			maps.forEach(([key, cb]) => {
				if(e.key === key) {
					e.preventDefault()
					cb(e)
				}
			})
		}

		document.onkeydown = onKey(
			[' ', e => {
				const player = document.getElementById('player')
				if (player.paused) {
					player.play()
				} else {
					player.pause()
				}

			}],
			['ArrowRight', onNext],
			['ArrowLeft', onPrev],
		)


	</script>
<html>
